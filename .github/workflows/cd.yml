name: CD

on:
  push:
    branches: [main]

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  ci:
    uses: ./.github/workflows/ci.yml

  deploy:
    runs-on: ubuntu-latest
    needs: ci

    permissions:
      contents: read
      packages: write

    steps:
      - uses: actions/checkout@v4

      - name: Lowercase image name
        run: echo "IMAGE_NAME=$(echo '${{ env.IMAGE_NAME }}' | tr '[:upper:]' '[:lower:]')" >> $GITHUB_ENV

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build and push Docker image
        run: |
          docker build \
            -t ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest \
            -t ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ github.sha }} \
            .
          docker push ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest
          docker push ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:${{ github.sha }}

      - name: Restart Azure App Service (pull new image)
        run: |
          python3 - << 'PYEOF'
          import xml.etree.ElementTree as ET
          import urllib.request, base64, os, sys

          profile_xml = os.environ["AZURE_PUBLISH_PROFILE"]
          app_name = os.environ["AZURE_WEBAPP_NAME"]

          root = ET.fromstring(profile_xml)
          profile = root.find('.//publishProfile[@publishMethod="MSDeploy"]')
          if profile is None:
              print("ERROR: MSDeploy profile not found in publish profile", file=sys.stderr)
              sys.exit(1)

          user = profile.get("userName")
          pwd  = profile.get("userPWD")
          creds = base64.b64encode(f"{user}:{pwd}".encode()).decode()

          url = f"https://{app_name}.scm.azurewebsites.net/api/restart"
          req = urllib.request.Request(url, method="POST",
                  headers={"Authorization": f"Basic {creds}"})
          with urllib.request.urlopen(req) as resp:
              print(f"Kudu restart: HTTP {resp.status}")
          PYEOF
        env:
          AZURE_PUBLISH_PROFILE: ${{ secrets.AZURE_PUBLISH_PROFILE }}
          AZURE_WEBAPP_NAME: ${{ secrets.AZURE_WEBAPP_NAME }}
